apt -y install apache2 libapache2-mod-php7.2 php7.2 unzip apt-transport-https

addgroup ooklaserver && useradd -d /etc/ooklaserver -m -g ooklaserver -s /bin/bash ooklaserver

su - ooklaserver

cd ~
wget https://install.speedtest.net/ooklaserver/ooklaserver.sh --no-check-certificate

chmod +x ooklaserver.sh && ./ooklaserver.sh install && exit


nano /etc/rc.local

#!/bin/sh
su ooklaserver -c './etc/ooklaserver/OoklaServer --daemon'
exit 0

chmod +x /etc/rc.local


sed -i 's/ServerTokens OS/ServerTokens Prod/' /etc/apache2/conf-available/security.conf
sed -i 's/ServerSignature On/ServerSignature Off/' /etc/apache2/conf-available/security.conf


wget http://install.speedtest.net/httplegacy/http_legacy_fallback.zip --no-check-certificate

apt -y install letsencrypt python-certbot-apache
apache2ctl stop
letsencrypt --authenticator standalone --installer apache -n --agree-tos --email noc@universotecnologia.com.br -d speedjuatuba.universotecnologiainternet.com.br

echo 'openSSL.server.privateKeyFile OoklaServer.allowedDomains = *.ookla.com, *.speedtest.net, *.universotecnologiainternet.com.br >> /etc/ooklaserver/OoklaServer.properties


echo 'openSSL.server.certificateFile = /etc/letsencrypt/live/speedjuatuba.universotecnologiainternet.com.br/fullchain.pem' >> /etc/ooklaserver/OoklaServer.properties
echo 'openSSL.server.privateKeyFile = /etc/letsencrypt/live/speedjuatuba.universotecnologiainternet.com.br/privkey.pem'    >> /etc/ooklaserver/OoklaServer.properties


echo 'openSSL.server.privateKeyFile OoklaServer.allowedDomains = *.ookla.com, *.speedtest.net, *.universotecnologiainternet.com.br >> /etc/ooklaserver/OoklaServer.properties.default
echo 'openSSL.server.certificateFile = /etc/letsencrypt/live/speedjuatuba.universotecnologiainternet.com.br/fullchain.pem' >> /etc/ooklaserver/OoklaServer.properties.default
echo 'openSSL.server.privateKeyFile  = /etc/letsencrypt/live/speedjuatuba.universotecnologiainternet.com.br/privkey.pem' >> /etc/ooklaserver/OoklaServer.properties.default


chown ooklaserver. /etc/letsencrypt/ -R

cd /etc/ooklaserver
./ooklaserver.sh stop
su ooklaserver -c  '/etc/ooklaserver/ooklaserver.sh start'